local beds = {
    -- Central Los Santos
    {x = 334.945, y = -1423.815, z = 32.07, h = 229.428, taken = false, model = 2117668672, zone = 1 },
    {x = 333.013, y = -1426.111, z = 32.07, h = 229.428, taken = false, model = 2117668672, zone = 1 },
    {x = 331.082, y = -1428.406, z = 32.07, h = 229.428, taken = false, model = 2117668672, zone = 1 },
    {x = 329.150, y = -1430.701, z = 32.07, h = 229.428, taken = false, model = 2117668672, zone = 1 },
    {x = 327.218, y = -1432.997, z = 32.07, h = 229.428, taken = false, model = 2117668672, zone = 1 },
    {x = 325.596, y = -1434.925, z = 32.07, h = 229.428, taken = false, model = 2117668672, zone = 1 },
    {x = 318.724, y = -1428.909, z = 32.07, h = 50.064, taken = false, model = 2117668672, zone = 1 },
    {x = 320.270, y = -1427.073, z = 32.07, h = 50.064, taken = false, model = 2117668672, zone = 1 },
    {x = 322.266, y = -1424.701, z = 32.07, h = 50.064, taken = false, model = 2117668672, zone = 1 },
    {x = 324.133, y = -1422.482, z = 32.07, h = 50.064, taken = false, model = 2117668672, zone = 1 },
    {x = 326.000, y = -1420.263, z = 32.07, h = 50.064, taken = false, model = 2117668672, zone = 1 },
    {x = 343.862, y = -1430.720, z = 32.07, h = 50.064, taken = false, model = 2117668672, zone = 1 },
    {x = 341.931, y = -1433.016, z = 32.07, h = 50.064, taken = false, model = 2117668672, zone = 1 },
    {x = 340.063, y = -1435.235, z = 32.07, h = 50.064, taken = false, model = 2117668672, zone = 1 },
    {x = 338.196, y = -1437.453, z = 32.07, h = 50.064, taken = false, model = 2117668672, zone = 1 },
    {x = 336.200, y = -1439.825, z = 32.07, h = 50.064, taken = false, model = 2117668672, zone = 1 },
    {x = 334.655, y = -1441.662, z = 32.07, h = 50.064, taken = false, model = 2117668672, zone = 1 },
    {x = 350.634, y = -1436.234, z = 32.07, h = 229.428, taken = false, model = 2117668672, zone = 1 },
    {x = 348.702, y = -1438.529, z = 32.07, h = 229.428, taken = false, model = 2117668672, zone = 1 },
    {x = 346.770, y = -1440.825, z = 32.07, h = 229.428, taken = false, model = 2117668672, zone = 1 },
    {x = 344.839, y = -1443.120, z = 32.07, h = 229.428, taken = false, model = 2117668672, zone = 1 },
    {x = 342.907, y = -1445.415, z = 32.07, h = 229.428, taken = false, model = 2117668672, zone = 1 },
    {x = 341.285, y = -1447.343, z = 32.07, h = 229.428, taken = false, model = 2117668672, zone = 1 },
    {x = 362.070, y = -1390.385, z = 32.07, h = 141.209, taken = false, model = 2117668672, zone = 1 },
    {x = 359.775, y = -1388.454, z = 32.07, h = 141.209, taken = false, model = 2117668672, zone = 1 },
    {x = 357.479, y = -1386.522, z = 32.07, h = 141.209, taken = false, model = 2117668672, zone = 1 },
    {x = 355.184, y = -1384.590, z = 32.07, h = 141.209, taken = false, model = 2117668672, zone = 1 },
    {x = 360.050, y = -1379.023, z = 32.07, h = 320.294, taken = false, model = 2117668672, zone = 1 },
    {x = 362.422, y = -1381.019, z = 32.07, h = 320.294, taken = false, model = 2117668672, zone = 1 },
    {x = 364.794, y = -1383.015, z = 32.07, h = 320.294, taken = false, model = 2117668672, zone = 1 },
    {x = 367.166, y = -1385.011, z = 32.07, h = 320.294, taken = false, model = 2117668672, zone = 1 },
    {x = 369.844, y = -1387.265, z = 32.07, h = 320.294, taken = false, model = 2117668672, zone = 1 },
    {x = 349.914, y = -1376.082, z = 32.07, h = 139.918, taken = false, model = 2117668672, zone = 1 },
    {x = 346.746, y = -1374.021, z = 32.07, h = 139.918, taken = false, model = 2117668672, zone = 1 },
    {x = 344.297, y = -1371.961, z = 32.07, h = 139.918, taken = false, model = 2117668672, zone = 1 },
    {x = 349.010, y = -1366.517, z = 32.07, h = 320.294, taken = false, model = 2117668672, zone = 1 },
    {x = 351.382, y = -1368.513, z = 32.07, h = 320.294, taken = false, model = 2117668672, zone = 1 },
    {x = 353.753, y = -1370.509, z = 32.07, h = 320.294, taken = false, model = 2117668672, zone = 1 },
    {x = 356.125, y = -1372.505, z = 32.07, h = 320.294, taken = false, model = 2117668672, zone = 1 },
    {x = 358.803, y = -1374.758, z = 32.07, h = 320.294, taken = false, model = 2117668672, zone = 1 },
    -- Paleto beds
    { x = -260.50990, y = 6320.551, z = 31.98509, h = 313.055, taken = false, model = 1631638868, zone = 2 },
    { x = -258.22390, y = 6381.164, z = 31.98509, h = 314.483, taken = false, model = 1631638868, zone = 2 },
    { x = -259.37320, y = 6309.082, z = 32.00083, h = 133.628, taken = false, model = -1091386327, zone = 2 },
    { x = -255.67320, y = 6325.247, z = 31.98509, h = 44.041, taken = false, model = 1631638868, zone = 2 },
    -- Sandy Beds
    { x = 1829.673, y = 3676.108, z = 33.822, h = 210.433, taken = false, model = 1631638868, zone = 3 },
    { x = 1825.775, y = 3678.536, z = 33.822, h = 300.614, taken = false, model = 1631638868, zone = 3 },
    { x = 1820.352, y = 3671.431, z = 33.829, h = 121.365, taken = false, model = 1631638868, zone = 3 },
    -- Pillbox
    { x = 359.06660, y = -579.27170, z = 42.84425, h = 340.000, taken = false, model = 2117668672, zone = 4 },
    { x = 356.83640, y = -578.41190, z = 42.84425, h = 340.000, taken = false, model = 2117668672, zone = 4 },
    { x = 354.39630, y = -577.52210, z = 42.84425, h = 340.000, taken = false, model = 2117668672, zone = 4 },
    { x = 351.88620, y = -576.62230, z = 42.84425, h = 340.000, taken = false, model = 2117668672, zone = 4 },
    { x = 349.56600, y = -575.78250, z = 42.84425, h = 340.000, taken = false, model = 2117668672, zone = 4 },
    { x = 356.58960, y = -584.98360, z = 42.84425, h = 160.000, taken = false, model = 2117668672, zone = 4 },
    { x = 354.15950, y = -584.10370, z = 42.84425, h = 160.000, taken = false, model = 2117668672, zone = 4 },
    { x = 351.59930, y = -583.12380, z = 42.84425, h = 160.000, taken = false, model = 2117668672, zone = 4 },
    { x = 348.97930, y = -582.20390, z = 42.84425, h = 160.000, taken = false, model = 2117668672, zone = 4 },
    { x = 325.60840, y = -567.03590, z = 42.84424, h = 340.000, taken = false, model = 2117668672, zone = 4 },
    { x = 328.52840, y = -568.10600, z = 42.84424, h = 340.000, taken = false, model = 2117668672, zone = 4 },
    { x = 331.40840, y = -569.17590, z = 42.84424, h = 340.000, taken = false, model = 2117668672, zone = 4 },
    { x = 329.14240, y = -575.35340, z = 42.84424, h = 160.000, taken = false, model = 2117668672, zone = 4 },
    { x = 326.13240, y = -574.26330, z = 42.84424, h = 160.000, taken = false, model = 2117668672, zone = 4 },
    { x = 323.03240, y = -573.06340, z = 42.84424, h = 160.000, taken = false, model = 2117668672, zone = 4 },
    { x = 361.03750, y = -579.45260, z = 42.84425, h = 340.000, taken = false, model = 2117668672, zone = 4 },
}

local bedsTaken = {}
local injuryBasePrice = 100

PW = nil

TriggerEvent('pw:loadFramework', function(obj)
    PW = obj
end)

AddEventHandler('playerDropped', function()
    if bedsTaken[source] ~= nil then
        beds[bedsTaken[source]].taken = false
    end
end)

RegisterServerEvent('pw_skeleton:server:RequestBed')
AddEventHandler('pw_skeleton:server:RequestBed', function(zone)
    for k, v in pairs(beds) do
        if v.zone == zone and not v.taken then
            v.taken = true
            bedsTaken[source] = k
            TriggerClientEvent('pw_skeleton:client:SendToBed', source, k, v)
            return
        end
    end

    TriggerClientEvent('pw_notify:client:SendAlert', source, { type = 'error', text = 'No beds available' })
end)

RegisterServerEvent('pw_skeleton:server:RPRequestBed')
AddEventHandler('pw_skeleton:server:RPRequestBed', function(plyCoords)
    local foundbed = false
    for k, v in pairs(beds) do
        local distance = #(vector3(v.x, v.y, v.z) - plyCoords)
        if distance < 3.0 then
            if not v.taken then
                v.taken = true
                foundbed = true
                TriggerClientEvent('pw_skeleton:client:RPSendToBed', source, k, v)
                return
            else
                TriggerClientEvent('pw_notify:client:SendAlert', source, { type = 'error', text = '~r~That bed is taken' })
            end
        end
    end

    if not foundbed then
        TriggerClientEvent('pw_notify:client:SendAlert', source, { type = 'error', text = '~r~Not near a hospital bed' })
    end
end)

RegisterServerEvent('pw_skeleton:server:EnteredBed')
AddEventHandler('pw_skeleton:server:EnteredBed', function()
    local src = source
    local injuries = GetCharsInjuries(src)

    local totalBill = injuryBasePrice

    if injuries ~= nil then
        for k, v in pairs(injuries.limbs) do
            if v.isDamaged then
                totalBill = totalBill + (injuryBasePrice * v.severity)
            end
        end

        if injuries.isBleeding > 0 then
            totalBill = totalBill + (injuryBasePrice * injuries.isBleeding)
        end
    end

    local injured = exports.pw_core:getCharacter(src)
    injured:Bank().removeMoney(totalBill)
    --injured:Bank().Remove(totalBill, "Medical Expenses")
    TriggerClientEvent('pw:notification:SendAlert', src, { type = 'inform', text = 'You were billed for $' .. totalBill .. ' for medical services & expenses' })
	TriggerClientEvent('pw_skeleton:client:FinishServices', src)
end)

RegisterServerEvent('pw_skeleton:server:LeaveBed')
AddEventHandler('pw_skeleton:server:LeaveBed', function(id)
    beds[id].taken = false
end)

RegisterServerEvent('pw_skeleton:server:RemoveInventory')
AddEventHandler('pw_skeleton:server:RemoveInventory', function()
    local _src = source
    local _char = exports.pw_core:getCharacter(_src)
    _char:Inventory():Remove().All(function(res)
    end)
end)

PW.RegisterServerCallback("pw_skeleton:getOnline", function(source, cb)    
    cb(#PW.CheckOnlineDuty('ems'))
end)

exports.pw_chat:AddChatCommand('bed', function(source, args, rawCommand)
    local _src = source
    
    TriggerClientEvent('pw_skeleton:client:RPCheckPos', _src)
end, {
    help = "Lay on bed",
    params = {}
}, -1)